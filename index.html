<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice PDF Parser → Excel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.0/xlsx.full.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    .box { border: 1px solid #ccc; padding: 15px; border-radius: 10px; max-width: 960px; }
    input[type="file"] { margin: 10px 0; }
    button { padding: 8px 12px; border-radius: 8px; cursor: pointer; border: none; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .primary { background: #0078d7; color: #fff; }
    .secondary { background: #28a745; color: #fff; }
    #tableWrap { margin-top: 15px; max-height: 400px; overflow:auto; }
    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
    th { background: #f7f7f7; position: sticky; top: 0; }
  </style>
</head>
<body>
  <h2>Invoice PDF Parser → Excel</h2>
  <div class="box">
    <p>Upload your invoice PDFs and click <b>Parse PDFs</b>. Then click <b>Download Excel</b> to export results in your format.</p>
    <input id="fileInput" type="file" accept="application/pdf" multiple />
    <br>
    <button id="parseBtn" class="primary" disabled>Parse PDFs</button>
    <button id="downloadBtn" class="secondary" disabled>Download Excel</button>
    <div id="status"></div>
    <div id="tableWrap"></div>
  </div>

  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    const fileInput = document.getElementById("fileInput");
    const parseBtn = document.getElementById("parseBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusEl = document.getElementById("status");
    const tableWrap = document.getElementById("tableWrap");
    let allRows = [];

    const COLUMNS = [
      "InvoiceNumber","InvoiceDate","InvoiceTotal","SupplierName",
      "BuyerPartNumber","SupplierPartNumber","Quantity","UnitOfMeasure",
      "NetWeight","ItemTotal","UnitPrice"
    ];

    fileInput.addEventListener("change", () => {
      parseBtn.disabled = fileInput.files.length === 0;
      downloadBtn.disabled = true;
      allRows = [];
      tableWrap.innerHTML = "";
      statusEl.textContent = "";
    });

    async function readPdf(file) {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(it => it.str).join(" ") + "\n";
      }
      return text;
    }

    function extractHeader(text) {
      const invoiceNumber = (text.match(/Customs\s+Invoice\s+(\d+)/i) || [])[1] || "";
      const invoiceDate = (text.match(/from\s+(\d{2}\/\d{2}\/\d{4})/) || [])[1] || "";
      const invoiceTotal = (text.match(/Overall amount in USD\s+([\d,]+\.\d{2})/) || [])[1]?.replace(/,/g, "") || "";
      const supplierName = (text.match(/invoice\s+\d+\s+(.*?),\s+Mankiew/i) || [])[1] || "";
      return { invoiceNumber, invoiceDate, invoiceTotal, supplierName: supplierName.trim() };
    }

    function extractItems(text) {
      const items = [];
      const regex = /\b\d{1,3}\s+(\d{5}\.\d+\.\d+\.\d+).*?([\d.]+)\s+([A-Za-z()]+).*?USD\/([A-Z]+)\s+([\d,]+\.\d{2})/gi;
      let m;
      while ((m = regex.exec(text)) !== null) {
        const product = m[1];
        const qty = parseFloat(m[2]) || "";
        const uom = m[4]; // from USD/<UOM>
        const itemTotal = parseFloat(m[5].replace(/,/g, "")) || "";
        const unitPrice = qty ? (itemTotal / qty).toFixed(5) : "";
        const buyerSupplierPart = product.split(".")[0];
        // try to find total L or KG value
        let netWeight = "";
        const netMatch = text.slice(m.index, regex.lastIndex).match(/([\d.]+)\s+(?:L|KG)\b/g);
        if (netMatch && netMatch.length >= 2) {
          netWeight = parseFloat(netMatch[1]);
        }
        items.push({
          BuyerPartNumber: buyerSupplierPart,
          SupplierPartNumber: buyerSupplierPart,
          Quantity: qty,
          UnitOfMeasure: uom,
          NetWeight: netWeight,
          ItemTotal: itemTotal,
          UnitPrice: unitPrice
        });
      }
      return items;
    }

    parseBtn.addEventListener("click", async () => {
      const files = Array.from(fileInput.files);
      if (!files.length) return;
      allRows = [];
      parseBtn.disabled = true;
      downloadBtn.disabled = true;
      statusEl.textContent = "Parsing PDFs...";
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        statusEl.textContent = `Processing ${f.name} (${i + 1}/${files.length})...`;
        const text = await readPdf(f);
        const header = extractHeader(text);
        const items = extractItems(text);
        items.forEach(it => {
          allRows.push({
            InvoiceNumber: header.invoiceNumber,
            InvoiceDate: header.invoiceDate,
            InvoiceTotal: header.invoiceTotal,
            SupplierName: header.supplierName,
            ...it
          });
        });
      }
      statusEl.textContent = `Parsed ${allRows.length} line(s).`;
      renderTable();
      downloadBtn.disabled = false;
      parseBtn.disabled = false;
    });

    function renderTable() {
      if (!allRows.length) return;
      let html = "<table><thead><tr>";
      COLUMNS.forEach(c => html += `<th>${c}</th>`);
      html += "</tr></thead><tbody>";
      allRows.forEach(r => {
        html += "<tr>" + COLUMNS.map(c => `<td>${r[c] ?? ""}</td>`).join("") + "</tr>";
      });
      html += "</tbody></table>";
      tableWrap.innerHTML = html;
    }

    downloadBtn.addEventListener("click", () => {
      const ws = XLSX.utils.json_to_sheet(allRows, { header: COLUMNS });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Parsed");
      XLSX.writeFile(wb, "parsed_invoices.xlsx");
    });
  </script>
</body>
</html>
