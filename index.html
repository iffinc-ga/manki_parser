<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MANKI Parser (React)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- ‚úÖ pdf.js (UMD) with reliable initialization loop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    (function waitForPdf() {
      if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
        console.log("‚úÖ pdf.js initialized successfully (CDN + worker)");
      } else {
        console.warn("‚è≥ Waiting for pdf.js to become available...");
        setTimeout(waitForPdf, 200);
      }
    })();
  </script>

  <style>
    .sticky-header { position: sticky; top: 0; z-index: 40;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .sticky-bar { position: sticky; top: 76px; z-index: 30; }
    .sticky-stats { position: sticky; top: 128px; z-index: 20; }
    .sticky-thead { position: sticky; top: 216px; z-index: 10; }
    .table-area {
      height: calc(100vh - 76px - 52px - 88px);
      overflow: auto;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef } = React;

    // ------------------------------
    // Hard-coded notes (edit freely)
    // ------------------------------
    const STATIC_NOTES = {
      "2563397": ["Check totals ‚Äî manual verification needed"]
    };

    // ------------------------------
    // PDF text extraction
    // ------------------------------
    async function extractPdfText(file) {
      if (!window.pdfjsLib) throw new Error("pdf.js not available");
      const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(i => i.str).join("\\n") + "\\n";
      }
      return text;
    }

    // ------------------------------
    // Excel export (simplified)
    // ------------------------------
    async function exportExcel(rows) {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Parsed Data");
      XLSX.writeFile(wb, "manki_export.xlsx");
    }

    // ------------------------------
    // Main React App
    // ------------------------------
    function App() {
      const [busy, setBusy] = useState(false);
      const [rows, setRows] = useState([]);
      const [message, setMessage] = useState(null);
      const [notes, setNotes] = useState(STATIC_NOTES);
      const [selectedInvoice, setSelectedInvoice] = useState("");

      const fileRef = useRef(null);

      async function handleFiles(e) {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;
        setBusy(true);
        setMessage("Parsing PDF...");
        try {
          const allRows = [];
          for (const f of files) {
            const txt = await extractPdfText(f);
            console.log("‚úÖ Parsed text length:", txt.length);
            // Simple demo parsing:
            const invoice = (txt.match(/Invoice\\s+(\\d+)/i) || [])[1] || "Unknown";
            const total = (txt.match(/Overall\\s+amount\\s+in\\s+USD\\s+([\\d,.]+)/i) || [])[1] || "";
            allRows.push({ file: f.name, invoice, total });
          }
          setRows(allRows);
          if (allRows.length) setSelectedInvoice(allRows[0].invoice);
          setMessage("Parse complete.");
        } catch (err) {
          console.error(err);
          setMessage("‚ùå " + err.message);
        } finally {
          setBusy(false);
        }
      }

      return (
        <div className="max-w-[1200px] mx-auto">
          <div className="sticky-header text-white px-6 py-5 rounded-b-2xl shadow">
            <h1 className="text-xl font-bold">üìã MANKI Parser</h1>
            <p className="opacity-90 text-sm">
              Upload PDF invoices, review parsed lines & notes, and export to Excel.
            </p>
          </div>

          {message && (
            <div className="bg-indigo-50 border border-indigo-200 text-indigo-800 px-4 py-2 my-2 mx-4 rounded">
              {message}
            </div>
          )}

          <div className="sticky-bar bg-white border-b border-slate-200 px-4 py-3 flex items-center gap-3">
            <input
              ref={fileRef}
              type="file"
              accept="application/pdf"
              multiple
              className="hidden"
              onChange={handleFiles}
            />
            <button
              onClick={() => fileRef.current.click()}
              disabled={busy}
              className="px-3 py-2 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60"
            >
              Choose PDF(s)
            </button>

            <div className="flex-1" />

            <button
              onClick={() => exportExcel(rows)}
              disabled={!rows.length || busy}
              className="px-3 py-2 rounded-lg font-semibold text-white bg-emerald-600 hover:bg-emerald-700 disabled:opacity-60"
            >
              Export Excel
            </button>
          </div>

          <div className="grid grid-cols-3 gap-4 p-4">
            <div className="col-span-2 bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
              <div className="table-area">
                <table className="w-full">
                  <thead className="sticky-thead bg-slate-100 text-xs uppercase tracking-wide">
                    <tr>
                      <th className="px-3 py-2 text-left">File</th>
                      <th className="px-3 py-2 text-left">Invoice</th>
                      <th className="px-3 py-2 text-left">Total</th>
                    </tr>
                  </thead>
                  <tbody className="text-sm">
                    {rows.map((r, idx) => (
                      <tr
                        key={idx}
                        className={
                          "border-b border-slate-200 hover:bg-slate-50 cursor-pointer " +
                          (selectedInvoice === r.invoice ? "bg-indigo-50" : "")
                        }
                        onClick={() => setSelectedInvoice(r.invoice)}
                      >
                        <td className="px-3 py-2">{r.file}</td>
                        <td className="px-3 py-2">{r.invoice}</td>
                        <td className="px-3 py-2">{r.total}</td>
                      </tr>
                    ))}
                    {!rows.length && (
                      <tr>
                        <td colSpan="3" className="text-center text-slate-500 py-4">
                          Upload PDF(s) to begin
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow border border-slate-200 p-4 h-[calc(100vh-216px-16px)] sticky top-[216px] overflow-auto">
              <h3 className="text-sm font-bold text-slate-800 mb-2">Notes</h3>
              {selectedInvoice ? (
                notes[selectedInvoice]?.length ? (
                  <ul className="list-disc pl-5 space-y-2 text-sm">
                    {notes[selectedInvoice].map((n, idx) => (
                      <li key={idx} className="text-slate-700">
                        {n}
                      </li>
                    ))}
                  </ul>
                ) : (
                  <p className="text-sm text-slate-500">
                    No notes for invoice <span className="font-semibold">{selectedInvoice}</span>.
                  </p>
                )
              ) : (
                <p className="text-sm text-slate-500">Select an invoice to view its notes.</p>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
